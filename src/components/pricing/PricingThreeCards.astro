---
/**
 * * pricing sections with toggle for monthly or yearly payments
 * This is designed for 3 pricing items
 */
import ShadowYellow from "@images/pricing/shadow-yellow.png";
import Check from "@tabler/icons/outline/check.svg";
import { Image } from "astro:assets";

import Button from "@/components/button/Button.astro";
import { getLocaleFromUrl } from "@/js/localeUtils";
import { getLocalizedRoute } from "@/js/translationUtils";

// get the current page locale to use in links to other pages
const currLocale = getLocaleFromUrl(Astro.url);

interface PricingFeature {
	text: string;
	included: boolean;
}

interface PricingPlan {
	name: string;
	monthlyPrice: number;
	yearlyPrice: number;
	description: string;
	isPopular?: boolean;
	features: PricingFeature[];
}

const plans: PricingPlan[] = [
	{
		name: "Basic",
		monthlyPrice: 10,
		yearlyPrice: 100,
		description: "Essential financial tools for individuals",
		features: [
			{ text: "No annual fee", included: true },
			{ text: "1% cashback on all purchases", included: true },
			{ text: "Mobile app access", included: true },
			{ text: "Standard customer support", included: true },
			{ text: "Basic spending analytics", included: true },
		],
	},
	{
		name: "Plus",
		monthlyPrice: 25,
		yearlyPrice: 250,
		description: "Enhanced benefits for everyday spending",
		isPopular: true,
		features: [
			{ text: "No annual fee", included: true },
			{ text: "3% cashback on select categories", included: true },
			{ text: "No foreign transaction fees", included: true },
			{ text: "Premium mobile app features", included: true },
			{ text: "24/7 customer support", included: true },
		],
	},
	{
		name: "Premium",
		monthlyPrice: 50,
		yearlyPrice: 500,
		description: "Comprehensive coverage for power users",
		features: [
			{ text: "All Plus features included", included: true },
			{ text: "5% cashback on all categories", included: true },
			{ text: "Airport lounge access", included: true },
			{ text: "Advanced financial planning tools", included: true },
			{ text: "Concierge service", included: true },
		],
	},
];
---

<section id="pricing-three-cards" class="overflow-hidden py-24" data-pricing="section">
	<div class="site-container">
		<div class="mx-auto mb-20 text-center md:max-w-3xl" id="three-cards-start-trigger">
			<div data-aos="fade-up" data-aos-trigger="#three-cards-start-trigger">
				<span class="badge">Zenith Card</span>
				<h2 class="h1 mb-8">Compare our plans</h2>
				<p class="text-muted-foreground mx-auto mb-12 max-w-sm">
					Choose the perfect plan for your financial needs. All plans include fraud protection,
					secure transactions, and our award-winning mobile app.
				</p>
			</div>
			<div
				class="bg-gradient-radial-dark-light relative mx-auto w-fit max-w-max rounded-full p-1 shadow-sm"
				data-billing="monthly"
				data-pricing="toggle"
				data-aos="fade-up"
				data-aos-delay="0.3"
				data-aos-trigger="#three-cards-start-trigger"
			>
				<label for="billingCheckbox" class="sr-only"
					>Toggle between monthly and yearly billing</label
				>
				<input
					class="peer absolute top-0 left-0 z-10 h-full w-full cursor-pointer opacity-0"
					type="checkbox"
					checked
					aria-label="Switch between monthly and yearly billing"
					data-pricing="checkbox"
				/>
				<div class="flex w-fit items-center">
					<div class="w-1/2 sm:w-auto">
						<button
							class="data-[billing=yearly]:text-muted-foreground focus:ring-opacity-40 flex h-full min-h-[40px] items-center justify-center rounded-full px-6 py-4 text-center text-sm font-medium focus:ring-4 focus:ring-white data-[billing=monthly]:bg-white data-[billing=monthly]:text-black sm:px-9 sm:py-5 sm:text-base"
							type="button"
							data-pricing="monthly">Monthly</button
						>
					</div>
					<div class="flex-1">
						<button
							class="flex h-full min-h-[40px] w-full items-center justify-center rounded-full px-6 py-4 text-center text-sm data-[billing=yearly]:bg-white sm:px-9 sm:py-5 sm:text-base"
							type="button"
							data-pricing="annual"
						>
							<div class="flex items-center">
								<p
									class="data-[billing=monthly]:text-muted-foreground mr-2 font-medium whitespace-nowrap data-[billing=yearly]:text-black"
									data-pricing="annual-text"
								>
									Annual
								</p>
								<span
									class="border-primary-text text-primary-text inline-flex rounded-full border px-2 py-0.5 text-xs font-medium uppercase sm:px-3 sm:py-1 sm:text-sm"
									>-20%</span
								>
							</div>
						</button>
					</div>
				</div>
			</div>
		</div>
		<div class="-m-4 flex flex-wrap items-center" id="pricing-three-cards-trigger">
			{
				plans.map((plan, index) => (
					<div
						class:list={[
							"w-full p-4 md:w-1/2 lg:w-1/3",
							plan.isPopular && "z-10 lg:-my-20", // Add negative margins to make it taller and z-index to ensure it's on top
						]}
					>
						<div
							class:list={[
								"rounded-5xl h-full overflow-hidden px-8",
								plan.isPopular
									? "bg-gradient-radial-light relative pt-16 pb-16"
									: "bg-gradient-radial-dark pt-12 pb-12",
							]}
							data-aos="fade-up"
							data-aos-delay={index * 0.2 + 0.7}
							data-aos-trigger="#pricing-three-cards-trigger"
						>
							{plan.isPopular && (
								<Image
									class="absolute top-0 left-0 w-full"
									quality={100}
									src={ShadowYellow}
									alt=""
								/>
							)}
							<p class="mb-2 text-lg font-light">{plan.name}</p>
							<p class="text-muted-foreground mb-6">{plan.description}</p>

							{plan.isPopular ? (
								<div class="-m-3 mb-3 flex flex-wrap items-center">
									<div class="w-auto p-3">
										<p class="text-5xl font-medium">
											<span class="monthly-price" data-price={plan.monthlyPrice}>
												${plan.monthlyPrice}
											</span>
											<span class="monthly-label text-muted-foreground text-base font-medium">
												/ month
											</span>
											<span class="yearly-price hidden" data-price={plan.yearlyPrice}>
												${plan.yearlyPrice}
											</span>
											<span class="yearly-label text-muted-foreground hidden text-base font-medium">
												/ year
											</span>
										</p>
									</div>
									<div class="w-auto p-3">
										<span class="border-primary-text text-primary-text rounded-full border px-3 py-1 text-sm font-medium">
											-20%
										</span>
									</div>
								</div>
							) : (
								<p class="mb-7 text-5xl font-medium">
									<span class="monthly-price" data-price={plan.monthlyPrice}>
										${plan.monthlyPrice}
									</span>
									<span class="monthly-label text-muted-foreground text-base font-medium">
										/ month
									</span>
									<span class="yearly-price hidden" data-price={plan.yearlyPrice}>
										${plan.yearlyPrice}
									</span>
									<span class="yearly-label text-muted-foreground hidden text-base font-medium">
										/ year
									</span>
								</p>
							)}

							<Button
								class="mb-7 w-full font-medium"
								variant={plan.isPopular ? "primary" : "outline"}
								href={getLocalizedRoute(currLocale, "/sign-up")}
							>
								Start now
							</Button>
							<p class="text-muted-foreground mb-4 text-xs font-light uppercase">What's included</p>
							<ul>
								{plan.features.map((feature) => (
									<li class="mb-4 flex items-center">
										<div class="border-primary-text mr-4 flex h-5 w-5 items-center justify-center rounded-full border">
											{feature.included ? (
												<Check class="text-primary-text size-3.5" />
											) : (
												<span class="text-muted-foreground">Ã—</span>
											)}
										</div>
										<p class="">{feature.text}</p>
									</li>
								))}
							</ul>
						</div>
					</div>
				))
			}
		</div>
	</div>
</section>

<script>
	function initPricingThreeCards() {
		const section = document.getElementById("pricing-three-cards");
		if (!section) return;

		// Get DOM elements
		const billingToggle = section.querySelector('[data-pricing="toggle"]');
		const billingCheckbox = section.querySelector('[data-pricing="checkbox"]') as HTMLInputElement;
		const monthlyBilling = section.querySelector('[data-pricing="monthly"]');
		const annualBilling = section.querySelector('[data-pricing="annual"]');
		const annualText = section.querySelector('[data-pricing="annual-text"]');

		// Get all pricing elements
		const monthlyPrices = section.querySelectorAll(".monthly-price");
		const monthlyLabels = section.querySelectorAll(".monthly-label");
		const yearlyPrices = section.querySelectorAll(".yearly-price");
		const yearlyLabels = section.querySelectorAll(".yearly-label");

		// Initialize state
		let isMonthly = true;

		// Function to update UI based on billing period
		function updateBillingUI() {
			// Update data attributes on all relevant elements
			const billingValue = isMonthly ? "monthly" : "yearly";
			billingToggle?.setAttribute("data-billing", billingValue);
			monthlyBilling?.setAttribute("data-billing", billingValue);
			annualBilling?.setAttribute("data-billing", billingValue);
			annualText?.setAttribute("data-billing", billingValue);

			if (isMonthly) {
				// Show monthly prices, hide yearly prices
				monthlyPrices.forEach((el) => el.classList.remove("hidden"));
				monthlyLabels.forEach((el) => el.classList.remove("hidden"));
				yearlyPrices.forEach((el) => el.classList.add("hidden"));
				yearlyLabels.forEach((el) => el.classList.add("hidden"));
			} else {
				// Show yearly prices, hide monthly prices
				monthlyPrices.forEach((el) => el.classList.add("hidden"));
				monthlyLabels.forEach((el) => el.classList.add("hidden"));
				yearlyPrices.forEach((el) => el.classList.remove("hidden"));
				yearlyLabels.forEach((el) => el.classList.remove("hidden"));
			}
		}

		// Function to animate the counters
		function animateCounters() {
			// Determine which prices to animate based on current state
			const pricesToAnimate = isMonthly ? monthlyPrices : yearlyPrices;

			pricesToAnimate.forEach((el) => {
				const price = el.getAttribute("data-price") || "0";
				const priceNum = parseInt(price);

				// Only animate visible elements
				if (!el.classList.contains("hidden")) {
					// Set initial content
					el.textContent = "$0";

					// Start animation
					const duration = 700;
					const startTime = performance.now();

					function updateCounter(currentTime: number) {
						const elapsed = currentTime - startTime;
						const progress = Math.min(elapsed / duration, 1);
						const currentValue = Math.floor(progress * priceNum);

						el.textContent = "$" + currentValue;

						if (progress < 1) {
							requestAnimationFrame(updateCounter);
						} else {
							el.textContent = "$" + priceNum;
						}
					}

					requestAnimationFrame(updateCounter);
				}
			});
		}

		// Toggle billing period when clicking the toggle
		billingCheckbox?.addEventListener("change", () => {
			isMonthly = billingCheckbox.checked;
			updateBillingUI();
			animateCounters();
		});

		// Add click handlers for the buttons
		monthlyBilling?.addEventListener("click", () => {
			isMonthly = true;
			if (billingCheckbox) billingCheckbox.checked = true;
			updateBillingUI();
			animateCounters();
		});

		annualBilling?.addEventListener("click", () => {
			isMonthly = false;
			if (billingCheckbox) billingCheckbox.checked = false;
			updateBillingUI();
			animateCounters();
		});

		// Initialize UI
		updateBillingUI();

		// Run initial animation after a short delay to ensure DOM is ready
		setTimeout(animateCounters, 100);
	}

	initPricingThreeCards();

	document.addEventListener("astro:after-swap", () => {
		initPricingThreeCards();
	});
</script>
